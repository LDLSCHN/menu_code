# menu_code
这是英飞凌四轮镜头组工程，基于TC264，元素写的很史，主要修改了menu，沿用了旧版menu的基本操作逻辑，主要优化了菜单运行性能，数据结构从链表改为栈，且加入智能渲染，即只刷新被修改的部分
以下内容作者为Copilot
### 新版架构（静态数组 + 页面栈）

```
┌─────────────────────────────────────────────────────┐
│  全局上下文 (MenuContext)                           │
│  ├── page_stack[8]  页面栈                          │
│  ├── stack_top      栈顶指针                        │
│  ├── current_page   当前页面指针                    │
│  ├── edit_mode      编辑模式 (0/1/2)                │
│  └── edit_step_level 步长级别                       │
└─────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────┐
│  页面 (MenuPage)                                    │
│  ├── name          页面名称                         │
│  ├── items[]       菜单项数组 (静态 const)          │
│  ├── item_count    项数量                           │
│  ├── cursor_pos    光标位置                         │
│  └── dirty_mask    脏标记 (16位)                    │
└─────────────────────────────────────────────────────┘
```

---

## 新版本改进

### 1. 内存管理优化

| 对比项 | 旧版 | 新版 |
|--------|------|------|
| 页面存储 | 动态链表 | 静态数组 |
| 菜单项 | 动态分配 | `const` 静态数组 |
| 内存占用 | 运行时分配 | 编译时确定 |
| 碎片风险 | 有 | 无 |

### 2. 页面导航改进

| 对比项 | 旧版 | 新版 |
|--------|------|------|
| 跳转方式 | 函数指针调用 `Init` | 页面栈压栈/弹栈 |
| 返回上级 | 需要记录上级页面 | 自动弹栈恢复 |
| 嵌套深度 | 无限制（内存限制） | 8层（可配置） |
| 状态保持 | 需手动保存 | 自动保持 |

### 3. 编辑模式改进

**旧版**：直接进入编辑，旋转修改数值

**新版**：三层状态机

```
浏览模式 (edit_mode=0)
    │ 短按可编辑项
    ▼
选择步长模式 (edit_mode=1) ←── 长按返回
    │ 旋转: 切换步长
    │ 短按: 确认步长
    ▼
编辑数值模式 (edit_mode=2) ←── 长按返回
    │ 旋转: 修改数值
    │ 长按: 返回选择步长
```

**步长选项**：

| 数据类型 | 步长选项 |
|---------|---------|
| 整数 | x1, x10, x100, x1000 |
| 浮点数 | x0.01, x0.1, x1, x10, x100 |

### 4. 渲染优化

| 对比项 | 旧版 | 新版 |
|--------|------|------|
| 刷新方式 | 每帧全部重绘 | 脏标记局部刷新 |
| 脏标记 | 无 | 16位 dirty_mask |
| 静态函数页面 | - | 每帧强制刷新 |


## 操作说明

### 浏览模式

| 操作 | 功能 |
|------|------|
| 旋转编码器 | 移动光标 |
| 短按 | 进入子菜单/编辑/执行动作/切换布尔 |
| 长按 | 返回上一级页面 |

### 选择步长模式（白色显示）

| 操作 | 功能 |
|------|------|
| 旋转编码器 | 切换步长 (x1/x10/x100...) |
| 短按 | 确认步长，进入编辑 |
| 长按 | 取消，返回浏览模式 |

### 编辑数值模式（绿色显示）

| 操作 | 功能 |
|------|------|
| 旋转编码器 | 以选中步长修改数值 |
| 长按 | 返回选择步长模式 |

---